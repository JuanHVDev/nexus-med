generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============ ENUMS ============
enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  CHECK
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============ CORE MODELS ============

model Clinic {
  id       BigInt  @id @default(autoincrement())
  name     String
  rfc      String  @unique
  address  String?
  phone    String?
  email    String?
  isActive Boolean @default(true)

  workingHours       Json?
  appointmentDuration Int?

  userClinics       UserClinic[]
  invitations      ClinicInvitation[]
  patients          Patient[]
  appointments      Appointment[]
  medicalNotes      MedicalNote[]
  invoices          Invoice[]
  services          Service[]
  serviceCategories ServiceCategory[]
  labOrders         LabOrder[]
  imagingOrders    ImagingOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rfc])
  @@index([isActive])
  @@map("clinics")
}

// Tabla de relación usuario-clínica (muchos a muchos)
model UserClinic {
  id        BigInt   @id @default(autoincrement())
  userId    String
  clinicId  BigInt
  role      UserRole @default(DOCTOR)
  joinedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@unique([userId, clinicId])
  @@index([userId])
  @@index([clinicId])
  @@map("user_clinics")
}

// Invitaciones a clínicas
model ClinicInvitation {
  id          BigInt           @id @default(autoincrement())
  email       String
  clinicId    BigInt
  role        UserRole
  invitedBy   String
  token       String           @unique
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime         @default(now())

  clinic      Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([clinicId])
  @@index([token])
  @@map("clinic_invitations")
}

model User {
  id            String  @id
  name          String
  email         String  @unique
  emailVerified Boolean @default(false)
  image         String?

  specialty     String?
  licenseNumber String?
  phone         String?
  isActive      Boolean @default(true)

  userClinics   UserClinic[]
  accounts      Account[]
  sessions      Session[]
  appointments  Appointment[]  @relation("DoctorAppointments")
  medicalNotes  MedicalNote[]
  prescriptions Prescription[]
  invoices      Invoice[]
  labOrders     LabOrder[]
  imagingOrders ImagingOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isActive])
  @@map("users")
}

// ============ PATIENT MODELS ============

model Patient {
  id       BigInt @id @default(autoincrement())
  clinicId BigInt
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  firstName  String
  lastName   String
  middleName String?
  curp       String?

  birthDate DateTime
  gender    Gender
  bloodType BloodType?

  email   String?
  phone   String?
  mobile  String?
  address String?
  city    String?
  state   String?
  zipCode String?

  isActive Boolean @default(true)
  deletedAt DateTime?
  notes    String?

  medicalHistory    MedicalHistory?
  emergencyContacts EmergencyContact[]
  appointments      Appointment[]
  medicalNotes      MedicalNote[]
  prescriptions     Prescription[]
  labOrders         LabOrder[]
  imagingOrders    ImagingOrder[]
  invoices          Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clinicId, curp])
  @@index([clinicId])
  @@index([clinicId, lastName])
  @@index([clinicId, curp])
  @@index([phone])
  @@index([email])
  @@index([isActive])
  @@map("patients")
}

model MedicalHistory {
  id        BigInt  @id @default(autoincrement())
  patientId BigInt  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  allergies          String[] @default([])
  currentMedications String[] @default([])
  chronicDiseases    String[] @default([])
  surgeries          String[] @default([])
  familyHistory      String?
  personalHistory   String?

  smoking  Boolean @default(false)
  alcohol  Boolean @default(false)
  drugs    Boolean @default(false)
  exercise String?
  diet     String?

  vitalSigns Json?
  vitalSignsRecordedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("medical_histories")
}

model EmergencyContact {
  id        BigInt  @id @default(autoincrement())
  patientId BigInt
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  name      String
  relation  String
  phone     String
  email     String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@map("emergency_contacts")
}

// ============ APPOINTMENT MODELS ============

model Appointment {
  id       BigInt @id @default(autoincrement())
  clinicId BigInt
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  patientId BigInt
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User   @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade)

  startTime DateTime
  endTime   DateTime
  status    AppointmentStatus @default(SCHEDULED)

  reason String?
  notes  String?

  medicalNote MedicalNote?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([clinicId, startTime])
  @@index([patientId])
  @@index([doctorId])
  @@index([doctorId, startTime])
  @@index([status])
  @@map("appointments")
}

// ============ MEDICAL RECORDS ============

model MedicalNote {
  id       BigInt @id @default(autoincrement())
  clinicId BigInt
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  patientId BigInt
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  appointmentId BigInt?      @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  specialty String?
  type     String? @map("type")
  chiefComplaint String
  currentIllness String?
  vitalSigns     Json?
  physicalExam   String?
  diagnosis      String
  prognosis      String?
  treatment      String?
  notes          String?

  prescriptions Prescription[]
  labOrders     LabOrder[]
  imagingOrders ImagingOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([patientId])
  @@index([patientId, createdAt])
  @@index([doctorId])
  @@map("medical_notes")
}

model Prescription {
  id BigInt @id @default(autoincrement())

  patientId BigInt
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  medicalNoteId BigInt
  medicalNote   MedicalNote @relation(fields: [medicalNoteId], references: [id], onDelete: Cascade)

  medications  Json
  instructions String?

  issueDate  DateTime  @default(now())
  validUntil DateTime?

  digitalSignature String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([doctorId])
  @@index([medicalNoteId])
  @@index([issueDate])
  @@map("prescriptions")
}

// ============ BILLING MODELS ============

model ServiceCategory {
  id       BigInt @id @default(autoincrement())
  clinicId BigInt
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  name        String
  description String?
  color       String?
  sortOrder   Int     @default(0)

  services Service[]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([clinicId, sortOrder])
  @@map("service_categories")
}

model Service {
  id       BigInt @id @default(autoincrement())
  clinicId BigInt
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  categoryId BigInt?
  category   ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  name        String
  description String?
  basePrice   Decimal @db.Decimal(10, 2)
  duration    Int?

  isActive Boolean @default(true)

  invoiceItems InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([clinicId, categoryId])
  @@index([isActive])
  @@map("services")
}

model Invoice {
  id       BigInt @id @default(autoincrement())
  clinicId BigInt
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  patientId BigInt
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  clinicInvoiceNumber String

  issuedById String
  issuedBy   User   @relation(fields: [issuedById], references: [id], onDelete: Cascade)

  issueDate DateTime  @default(now())
  dueDate   DateTime?

  subtotal Decimal @db.Decimal(10, 2)
  tax      Decimal @default(0) @db.Decimal(10, 2)
  discount Decimal @default(0) @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)

  status InvoiceStatus @default(PENDING)

  notes String?

  items    InvoiceItem[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clinicId, clinicInvoiceNumber])
  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([issueDate])
  @@map("invoices")
}

model InvoiceItem {
  id        BigInt  @id @default(autoincrement())
  invoiceId BigInt
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  serviceId BigInt?
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  discount    Decimal @default(0) @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@index([serviceId])
  @@map("invoice_items")
}

model Payment {
  id        BigInt  @id @default(autoincrement())
  invoiceId BigInt
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amount    Decimal       @db.Decimal(10, 2)
  method    PaymentMethod
  reference String?
  notes     String?

  paymentDate DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@index([paymentDate])
  @@map("payments")
}

// ============ LABORATORY MODELS ============

model LabOrder {
  id       BigInt @id @default(autoincrement())
  clinicId BigInt
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  patientId BigInt
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  medicalNoteId BigInt?
  medicalNote   MedicalNote? @relation(fields: [medicalNoteId], references: [id], onDelete: SetNull)

  orderDate   DateTime      @default(now())
  tests       Json          // Array of { name, code, price }
  instructions String?

  status OrderStatus @default(PENDING)

  results LabResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([orderDate])
  @@map("lab_orders")
}

model LabResult {
  id         BigInt  @id @default(autoincrement())
  labOrderId BigInt
  labOrder   LabOrder @relation(fields: [labOrderId], references: [id], onDelete: Cascade)

  testName      String
  result        String?
  unit          String?
  referenceRange String?
  flag          String?   // LOW, HIGH, NORMAL, CRITICAL

  resultDate DateTime?

  createdAt DateTime @default(now())

  @@index([labOrderId])
  @@map("lab_results")
}

// ============ IMAGING MODELS ============

model ImagingOrder {
  id       BigInt @id @default(autoincrement())
  clinicId BigInt
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  patientId BigInt
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   User   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  medicalNoteId BigInt?
  medicalNote   MedicalNote? @relation(fields: [medicalNoteId], references: [id], onDelete: SetNull)

  orderDate    DateTime      @default(now())
  studyType    String        // RX, TAC, RM, USG, etc.
  bodyPart     String
  reason       String?
  clinicalNotes String?

  status OrderStatus @default(PENDING)

  reportUrl   String?   // PDF report
  imagesUrl   String?   // DICOM or images
  findings    String?
  impression  String?

  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([orderDate])
  @@index([studyType])
  @@map("imaging_orders")
}

// ============ BETTER-AUTH MODELS ============

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
